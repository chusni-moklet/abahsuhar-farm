<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ternak</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 p-3 md:p-6 min-h-screen">
<div id="nav"></div>

<div class="max-w-6xl mx-auto">
<h1 class="text-xl md:text-2xl font-bold mb-4">ğŸ“Š Dashboard Ternak</h1>

<!-- FILTER -->
<div class="bg-white p-3 md:p-4 rounded-xl shadow mb-4 flex flex-col sm:flex-row gap-2 md:gap-4">
  <input type="date" id="start" class="border p-2 rounded w-full text-sm md:text-base" placeholder="Tanggal Mulai">
  <input type="date" id="end" class="border p-2 rounded w-full text-sm md:text-base" placeholder="Tanggal Akhir">
  <button onclick="applyFilter()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm md:text-base whitespace-nowrap">
    Filter
  </button>
  <button onclick="resetFilter()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm md:text-base whitespace-nowrap">
    Reset
  </button>
</div>

<!-- CARD -->
<div id="cards" class="grid grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 mb-4 md:mb-6"></div>

<!-- GRAFIK -->
<div class="bg-white p-3 md:p-4 rounded-xl shadow mb-4 md:mb-6">
  <canvas id="produksi"></canvas>
</div>

<div class="bg-white p-3 md:p-4 rounded-xl shadow mb-4 md:mb-6">
  <canvas id="keuangan"></canvas>
</div>

<div class="bg-white p-3 md:p-4 rounded-xl shadow">
  <canvas id="laba"></canvas>
</div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbyP2sIYSWEuYipv_hqMru_pIaoYJ9bG_RoZfCMormsy4NJp0ZgVDJs-HOxGbN91Q5FD9Q/exec";
let raw, prodChart, finChart, labaChart;

// navbar
fetch("navbar.html").then(r=>r.text()).then(t=>nav.innerHTML=t);

// load data
fetch(URL).then(r=>r.json()).then(d=>{
  raw = d;
  render(d);
}).catch(err=>{
  console.error("Error loading data:", err);
  cards.innerHTML = '<div class="col-span-2 text-center text-red-600">Gagal memuat data. Pastikan URL Google Apps Script sudah benar.</div>';
});

// filter
function applyFilter(){
  if(!raw){
    alert("Data belum dimuat");
    return;
  }
  
  const s = start.value ? new Date(start.value) : null;
  const e = end.value ? new Date(end.value) : null;

  const f = {};
  for(let k in raw){
    f[k] = raw[k].filter(r=>{
      const t = new Date(r[0]);
      return (!s || t>=s) && (!e || t<=e);
    });
  }
  render(f);
}

// reset filter
function resetFilter(){
  start.value = '';
  end.value = '';
  if(raw) render(raw);
}

// render
function render(d){
  // Cek apakah data ada
  if(!d || !d.telur || !d.tetas || !d.jual || !d.keluar){
    cards.innerHTML = '<div class="col-span-2 text-center text-gray-600">Tidak ada data untuk ditampilkan</div>';
    return;
  }

  const telur = sum(d.telur,1);
  const menetas = sum(d.tetas,1);
  const terjual = sum(d.jual,1);
  const pemasukan = sum(d.jual,4);
  const pengeluaran = sum(d.keluar,2);
  const laba = pemasukan - pengeluaran;

  cards.innerHTML = `
    <div class="card">ğŸ¥š Telur Masuk<br><span class="text-2xl">${telur}</span></div>
    <div class="card">ğŸ£ Menetas<br><span class="text-2xl">${menetas}</span></div>
    <div class="card">ğŸ›’ Terjual<br><span class="text-2xl">${terjual}</span></div>
    <div class="card">ğŸ’° Masuk<br><span class="text-xl">Rp ${pemasukan.toLocaleString('id-ID')}</span></div>
    <div class="card">ğŸ’¸ Keluar<br><span class="text-xl">Rp ${pengeluaran.toLocaleString('id-ID')}</span></div>
    <div class="card bg-green-600 text-white">ğŸ“ˆ Laba<br><span class="text-xl">Rp ${laba.toLocaleString('id-ID')}</span></div>
  `;

  grafikProduksi(menetas, terjual);
  grafikKeuangan(d);
  grafikLaba(pemasukan, pengeluaran);
}

function sum(data, idx){
  return data.reduce((a,b)=>a+Number(b[idx]||0),0);
}

// grafik
function grafikProduksi(menetas, terjual){
  if(prodChart) prodChart.destroy();
  prodChart = new Chart(produksi,{
    type:"bar",
    data:{
      labels:["Menetas","Terjual"],
      datasets:[{
        label:"Jumlah",
        data:[menetas,terjual],
        backgroundColor:["#22c55e","#3b82f6"]
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false}
      }
    }
  });
}

function grafikKeuangan(d){
  if(finChart) finChart.destroy();
  finChart = new Chart(keuangan,{
    type:"bar",
    data:{
      labels:["Pemasukan","Pengeluaran"],
      datasets:[{
        label:"Rupiah",
        data:[sum(d.jual,4),sum(d.keluar,2)],
        backgroundColor:["#16a34a","#dc2626"]
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false}
      }
    }
  });
}

function grafikLaba(masuk, keluar){
  if(labaChart) labaChart.destroy();
  labaChart = new Chart(laba,{
    type:"line",
    data:{
      labels:["Pemasukan","Pengeluaran","Laba"],
      datasets:[{
        label:"Rupiah",
        data:[masuk,keluar,masuk-keluar],
        borderColor:"#22c55e",
        backgroundColor:"rgba(34,197,94,0.1)",
        fill:true,
        tension:0.4
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false}
      }
    }
  });
}
</script>

<style>
.card{
  background:white;
  padding:12px;
  border-radius:12px;
  font-weight:bold;
  font-size:14px;
  text-align:center;
}
@media (min-width: 768px) {
  .card{
    padding:16px;
    font-size:16px;
  }
}
</style>
</body>
</html>
